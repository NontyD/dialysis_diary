{% extends "pages/base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calendar</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="calendar"></div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        selectable: true,
        editable: true,
        events: "/calendar/events/",

        select: function (info) {
            var title = prompt("Enter event title:");
            if (title) {
                var startDateTime = prompt("Enter start date and time (YYYY-MM-DD HH:MM):", info.startStr.replace("T", " ").slice(0, 16));
                if (!startDateTime) {
                    alert("Event must have a start time.");
                    return;
                }

                var endDateTime = prompt("Enter end date and time (YYYY-MM-DD HH:MM):", info.endStr ? info.endStr.replace("T", " ").slice(0, 16) : startDateTime);
                if (!endDateTime) {
                    alert("Event must have an end time.");
                    return;
                }

                fetch("/calendar/add_event/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    body: JSON.stringify({
                        title: title,
                        start: startDateTime,
                        end: endDateTime,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        calendar.refetchEvents();
                    } else {
                        alert("Failed to add event: " + data.error);
                    }
                })
                .catch(error => console.error("Error:", error));
            }
            calendar.unselect();
        }
    });
    calendar.render();
});

// CSRF token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        let cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    </script>
    <div class="text-center mt-4">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</body>
</html>
{% endblock %}